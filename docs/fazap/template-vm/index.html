<!doctype html><html lang=pt-br class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.100.2"><link rel=alternate type=application/rss+xml href=https://sandrorgguimaraes.github.io/docs/fazap/template-vm/index.xml><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Template de VM's | Diário de Bordo</title><meta name=description content="Vamos instalar o KVM e suas dependências em uma máquina Ubuntu para gerar templates que serão utilizados na criação das máquinas virtuais."><meta property="og:title" content="Template de VM's"><meta property="og:description" content="Vamos instalar o KVM e suas dependências em uma máquina Ubuntu para gerar templates que serão utilizados na criação das máquinas virtuais."><meta property="og:type" content="website"><meta property="og:url" content="https://sandrorgguimaraes.github.io/docs/fazap/template-vm/"><meta itemprop=name content="Template de VM's"><meta itemprop=description content="Vamos instalar o KVM e suas dependências em uma máquina Ubuntu para gerar templates que serão utilizados na criação das máquinas virtuais."><meta name=twitter:card content="summary"><meta name=twitter:title content="Template de VM's"><meta name=twitter:description content="Vamos instalar o KVM e suas dependências em uma máquina Ubuntu para gerar templates que serão utilizados na criação das máquinas virtuais."><link rel=preload href=/scss/main.min.c58ce5d45149df8e10859c3eb1022295682982407b61dc69aa80c9ba066ffb49.css as=style><link href=/scss/main.min.c58ce5d45149df8e10859c3eb1022295682982407b61dc69aa80c9ba066ffb49.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MPCHWKW6D6"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MPCHWKW6D6',{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class=font-weight-bold>Diário de Bordo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/ficaadica/><span>#FicaaDica</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>Vivendo & Aprendendo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><i class='fas fa-book'></i><span class=active>Colocando em prática</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Buscar no site…" aria-label="Buscar no site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.057fb0b98b617ff4bb8b11f3ad8f1c29.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Buscar no site…" aria-label="Buscar no site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.057fb0b98b617ff4bb8b11f3ad8f1c29.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Colocando em prática</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsfazap-li><input type=checkbox id=m-docsfazap-check checked>
<label for=m-docsfazap-check><a href=/docs/fazap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsfazap><span>Fazendo e aprendendo</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsfazaptemplate-vm-li><input type=checkbox id=m-docsfazaptemplate-vm-check>
<label for=m-docsfazaptemplate-vm-check><a href=/docs/fazap/template-vm/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id=m-docsfazaptemplate-vm><span class=td-sidebar-nav-active-item>Template de VM's</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsfazapterraform-li><input type=checkbox id=m-docsfazapterraform-check>
<label for=m-docsfazapterraform-check><a href=/docs/fazap/terraform/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsfazapterraform><span>Terraform</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docstrilhadeestudo-li><input type=checkbox id=m-docstrilhadeestudo-check>
<label for=m-docstrilhadeestudo-check><a href=/docs/trilhadeestudo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstrilhadeestudo><span>Trilha de Estudos</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docstrilhadeestudodiario-de-bordo-v1-li><input type=checkbox id=m-docstrilhadeestudodiario-de-bordo-v1-check>
<label for=m-docstrilhadeestudodiario-de-bordo-v1-check><a href=/docs/trilhadeestudo/diario-de-bordo-v1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstrilhadeestudodiario-de-bordo-v1><span>Data Warehouse</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstrilhadeestudodiario-de-bordo-v1visao-geral-li><input type=checkbox id=m-docstrilhadeestudodiario-de-bordo-v1visao-geral-check>
<label for=m-docstrilhadeestudodiario-de-bordo-v1visao-geral-check><a href=/docs/trilhadeestudo/diario-de-bordo-v1/visao-geral/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstrilhadeestudodiario-de-bordo-v1visao-geral><span>Visão geral</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstrilhadeestudodiario-de-bordo-v1modelagem-li><input type=checkbox id=m-docstrilhadeestudodiario-de-bordo-v1modelagem-check>
<label for=m-docstrilhadeestudodiario-de-bordo-v1modelagem-check><a href=/docs/trilhadeestudo/diario-de-bordo-v1/modelagem/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstrilhadeestudodiario-de-bordo-v1modelagem><span>Modelagem Multidimensional</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscertificacoes-li><input type=checkbox id=m-docscertificacoes-check>
<label for=m-docscertificacoes-check><a href=/docs/certificacoes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoes><span>Partiu Certificação!</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscertificacoescka-li><input type=checkbox id=m-docscertificacoescka-check>
<label for=m-docscertificacoescka-check><a href=/docs/certificacoes/cka/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka><span>Certified Kubernetes Administrator (CKA)</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscertificacoescka01_componentes-li><input type=checkbox id=m-docscertificacoescka01_componentes-check>
<label for=m-docscertificacoescka01_componentes-check><a href=/docs/certificacoes/cka/01_componentes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka01_componentes><span>Componentes Básicos</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscertificacoescka02_objetos-li><input type=checkbox id=m-docscertificacoescka02_objetos-check>
<label for=m-docscertificacoescka02_objetos-check><a href=/docs/certificacoes/cka/02_objetos/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka02_objetos><span>Objetos Básicos</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscertificacoescka03_agendamento-li><input type=checkbox id=m-docscertificacoescka03_agendamento-check>
<label for=m-docscertificacoescka03_agendamento-check><a href=/docs/certificacoes/cka/03_agendamento/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka03_agendamento><span>Agendamento</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscertificacoescka04_log_monitoracao-li><input type=checkbox id=m-docscertificacoescka04_log_monitoracao-check>
<label for=m-docscertificacoescka04_log_monitoracao-check><a href=/docs/certificacoes/cka/04_log_monitoracao/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka04_log_monitoracao><span>Log & Monitoração</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscertificacoescka05_gerenciar_apps-li><input type=checkbox id=m-docscertificacoescka05_gerenciar_apps-check>
<label for=m-docscertificacoescka05_gerenciar_apps-check><a href=/docs/certificacoes/cka/05_gerenciar_apps/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka05_gerenciar_apps><span>Gerenciar Ciclos de Vida de Aplicações</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscertificacoescka06_manutencao_cluster-li><input type=checkbox id=m-docscertificacoescka06_manutencao_cluster-check>
<label for=m-docscertificacoescka06_manutencao_cluster-check><a href=/docs/certificacoes/cka/06_manutencao_cluster/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscertificacoescka06_manutencao_cluster><span>Manutenção do Cluster</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstodo-li><input type=checkbox id=m-docstodo-check>
<label for=m-docstodo-check><a href=/docs/todo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docstodo><span>TODO: A fazer</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="taxonomy taxonomy-terms-cloud"><h5 class=taxonomy-title>O que há nesta página</h5></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#entendendo-os-conceitos>Entendendo os conceitos</a></li><li><a href=#instalando-os-componentes>Instalando os componentes</a><ul><li><a href=#validando--concluindo-a-instalação>Validando / concluindo a instalação</a></li><li><a href=#consultando-o-libvirt>Consultando o <code>libvirt</code></a></li></ul></li><li><a href=#criando-templates-de-máquinas-virtuais>Criando templates de máquinas virtuais</a><ul><li><a href=#escolhendo-a-imagem-base>Escolhendo a imagem base</a></li><li><a href=#preparando-para-a-instalação>Preparando para a instalação</a></li><li><a href=#instalando-o-sistema-operacional>Instalando o sistema operacional</a></li><li><a href=#acessando-a-máquina-virtual>Acessando a máquina virtual</a></li><li><a href=#ajustes-pós-install>Ajustes pós install</a></li><li><a href=#limpando-a-imagem>Limpando a imagem</a></li></ul></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud"><h5 class=taxonomy-title>Colabore</h5></div><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/tree/main/content/pt-br/docs/fazap/template-vm/_index.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> Ver código da página</a>
<a href=https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/edit/main/content/pt-br/docs/fazap/template-vm/_index.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Editar essa página</a>
<a href="https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/new/main/content/pt-br/docs/fazap/template-vm/_index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Criar uma subpágina</a>
<a href="https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/issues/new?title=Template%20de%20VM%27s" class=td-page-meta--issue target=_blank rel=noopener><i class="fab fa-github fa-fw"></i> Relatar um problema de documentação</a></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://sandrorgguimaraes.github.io/docs/>Colocando em prática</a></li><li class=breadcrumb-item><a href=https://sandrorgguimaraes.github.io/docs/fazap/>Fazendo e aprendendo</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://sandrorgguimaraes.github.io/docs/fazap/template-vm/>Template de VM's</a></li></ol></nav><div class=td-content><h1>Template de VM's</h1><div class=lead>Vamos instalar o KVM e suas dependências em uma máquina Ubuntu para gerar templates que serão utilizados na criação das máquinas virtuais.</div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sandrorgguimaraes.github.io/categories/fazendo-e-aprendendo/ data-taxonomy-term=fazendo-e-aprendendo><span class=taxonomy-label>fazendo e aprendendo</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sandrorgguimaraes.github.io/tags/terraform/ data-taxonomy-term=terraform><span class=taxonomy-label>terraform</span></a></li><li><a class=taxonomy-term href=https://sandrorgguimaraes.github.io/tags/kvm/ data-taxonomy-term=kvm><span class=taxonomy-label>kvm</span></a></li><li><a class=taxonomy-term href=https://sandrorgguimaraes.github.io/tags/libvirt/ data-taxonomy-term=libvirt><span class=taxonomy-label>libvirt</span></a></li><li><a class=taxonomy-term href=https://sandrorgguimaraes.github.io/tags/qemu/ data-taxonomy-term=qemu><span class=taxonomy-label>qemu</span></a></li><li><a class=taxonomy-term href=https://sandrorgguimaraes.github.io/tags/template-maquina-virtual/ data-taxonomy-term=template-maquina-virtual><span class=taxonomy-label>template maquina virtual</span></a></li></ul></div><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i>&nbsp; 11 minute read &nbsp;</p></header><blockquote><p><em><strong>Observações / informações iniciais:</strong></em></p><ul><li>Os procedimentos abaixo foram aplicados em um computador com o <code>Ubuntu 20.04.4 LTS</code>.</li><li>Utilizamos como fonte de estudo os artigos listados na seção <a href=/blog/linux/kvm-libvirt/>Vivendo & Aprendendo -> Linux -> KVM / libvirt</a>
.</li></ul></blockquote><h2 id=entendendo-os-conceitos>Entendendo os conceitos</h2><p>A <a href=https://en.wikipedia.org/wiki/Hardware_virtualization target=_blank rel=noopener>virtualização de hardware</a>
atualmente é uma tecnologia estável e madura, não sendo o objetivo deste material explorar todas as suas nuances e caracteristicas (quem sabe mais pra frente).</p><p>O objetivo aqui é demonstrar como criar os templates (modelos) de máquinas virtuais, que serão utilizados posteriormente.</p><p>Primeiro vamos conhecer os principais componentes que permitirão que isso aconteça.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>KVM</h4><p><a href=https://www.linux-kvm.org/page/Main_Page target=_blank rel=noopener><em><strong>K</strong>ernel-based <strong>V</strong>irtual <strong>M</strong>achine</em></a>
é uma solução de virtualização completa para Linux em hardware x86 contendo extensões de virtualização (<a href=https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_%28VT-x%29 target=_blank rel=noopener>Intel VT</a>
ou <a href=https://en.wikipedia.org/wiki/X86_virtualization#AMD_virtualization_%28AMD-V%29 target=_blank rel=noopener>AMD-V</a>
). Ele consiste em um módulo de kernel carregável o <code>kvm.ko</code> que fornece a infraestrutura central de virtualização e um módulo específico do processador <code>kvm-intel.ko</code> ou <code>kvm-amd.ko</code>.</p><p>Usando o KVM, é possível executar várias máquinas virtuais executando imagens não modificadas do Linux ou do Windows. Cada máquina virtual possui hardware virtualizado privado: uma placa de rede, disco, adaptador gráfico, etc.</p></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>libvirt</h4>O projeto <a href=https://libvirt.org/ target=_blank rel=noopener>libvirt</a>
é um kit de ferramentas para gerenciar <a href=https://libvirt.org/platforms.html target=_blank rel=noopener>plataformas de virtualização</a>
é acessível a partir de C, Python, Perl, Go e muito mais, está licenciado sob licenças de código aberto, suporta <a href=https://libvirt.org/drvqemu.html target=_blank rel=noopener>KVM</a>
, <a href=https://libvirt.org/drvqemu.html target=_blank rel=noopener>Hypervisor.framework</a>
, <a href=https://libvirt.org/drvqemu.html target=_blank rel=noopener>QEMU</a>
, <a href=https://libvirt.org/drvxen.html target=_blank rel=noopener>Xen</a>
, <a href=https://libvirt.org/drvvirtuozzo.html target=_blank rel=noopener>Virtuozzo</a>
, <a href=https://libvirt.org/drvesx.html target=_blank rel=noopener>VMWare ESX</a>
, <a href=https://libvirt.org/drvlxc.html target=_blank rel=noopener>LXC</a>
, <a href=https://libvirt.org/drvbhyve.html target=_blank rel=noopener>BHyve</a>
e <a href=https://libvirt.org/drivers.html target=_blank rel=noopener>mais</a>
, tem como alvo Linux, FreeBSD, <a href=https://libvirt.org/windows.html target=_blank rel=noopener>Windows</a>
e <a href=https://libvirt.org/macos.html target=_blank rel=noopener>MacOS</a>
e é usado por <a href=https://libvirt.org/apps.html target=_blank rel=noopener>muitas aplicações</a>
.</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>QEMU</h4><p><a href=https://www.qemu.org/ target=_blank rel=noopener>QEMU</a>
é um emulador e virtualizador de máquina genérico e de código aberto.</p><p>O QEMU pode ser usado de várias maneiras diferentes. O mais comum é para “emulação de sistema”, onde fornece um modelo virtual de uma máquina inteira (CPU, memória e dispositivos emulados) para executar um sistema operacional convidado. Neste modo, a CPU pode ser totalmente emulada ou pode funcionar com um hypervisor como <a href=%28https://www.linux-kvm.org/page/Main_Page%29>KVM</a>
, <a href=https://xenproject.org/ target=_blank rel=noopener>Xen</a>
, Hax ou Hypervisor.Framework para permitir que o convidado seja executado diretamente na CPU do host.</p><p>A segunda maneira suportada de usar o QEMU é a “emulação de modo de usuário”, onde o QEMU pode iniciar processos compilados para uma CPU em outra CPU. Neste modo a CPU é sempre emulada.</p></div><p>A imagem abaixo ilustra de forma simples a relação entre o hardware físico (CPU, memória, discos, placa de rede, etc.) o Hypervisor e as máquinas virtuais.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:611px><img class=card-img-top src=/docs/fazap/template-vm/exemplo-vm_hua1d768c0155465d5bfde8bb1582d873f_100216_601x355_fill_box_smart1_3.png width=601 height=355><div class="card-body px-0 pt-2 pb-0"><p class=card-text>Fonte: www.revistaespacios.com/a16v37n27/16372721.html</p></div></div><h2 id=instalando-os-componentes>Instalando os componentes</h2><p>Como todos os componentes (KVM, libvirt e QEMU) estam disponíveis nos repositórios upstream do Ubuntu, usaremos o gerenciador de pacotes <code>apt</code> para a instalação dos mesmos, para outras distribuições Linux ou sistemas operacionais verifique a documentação correspondente do <a href=https://www.linux-kvm.org/page/Downloads target=_blank rel=noopener>KVM</a>
, <a href=https://libvirt.org/docs.html target=_blank rel=noopener>libvirt</a>
e <a href=https://www.qemu.org/download/ target=_blank rel=noopener>QEMU</a>
.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Atualiza a lista de pacotes disponíveis</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Instalação dos pacotes principais do KVM / libvirt / QEMU</span>
</span></span><span style=display:flex><span>sudo apt -y install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  qemu-kvm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  libvirt-daemon <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  bridge-utils <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  virtinst <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  libvirt-daemon-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Instalação de pacotes adicionais</span>
</span></span><span style=display:flex><span>sudo apt -y install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  virt-top <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  libguestfs-tools <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  libosinfo-bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  qemu-system <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  virt-manager
</span></span></code></pre></div><h3 id=validando--concluindo-a-instalação>Validando / concluindo a instalação</h3><h4 id=testando-o-kvm>Testando o KVM</h4><p>Para validar se o KVM está instalado corretamente e se a CPU está com a <a href=https://en.wikipedia.org/wiki/X86_virtualization target=_blank rel=noopener>virtualização x86</a>
habilitada, utilize o utilitário <a href=http://manpages.ubuntu.com/manpages/jammy/en/man1/kvm-ok.1.html target=_blank rel=noopener>kvm-ok</a>
.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kvm-ok
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INFO: /dev/kvm exists
</span></span><span style=display:flex><span>KVM acceleration can be used
</span></span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Extraído da documentação:</h4>Em alguns casos de falha, o <strong>kvm-ok</strong> fornece dicas sobre como você pode habilitar o KVM em um sistema onde ele é arbitrariamente desabilitado.</div><h4 id=checando-o-modulo-vhost_net>Checando o modulo <code>vhost_net</code></h4><p>O módulo <code>vhost_net</code> fornecerá ferramentas semelhantes aos comandos <code>ls</code>, <code>cat</code>, <code>top</code> para uso com máquinas virtuais, para certificar que ele está carregado e habilitado, use o código abaixo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Verifica se o modulo está carregado, senão carrega o modulo do Kernel</span>
</span></span><span style=display:flex><span><span style=color:#75715e># e já adiciona no arquivo &#39;/etc/modules&#39; para ser carregado na inicialização</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! lsmod | grep vhost; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  sudo modprobe vhost_net;
</span></span><span style=display:flex><span>  echo vhost_net | sudo tee -a /etc/modules;
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><h3 id=consultando-o-libvirt>Consultando o <code>libvirt</code></h3><p>Para verificar se o serviço de virtualização está devidamente ativo execute o comando <code>sudo systemctl status libvirtd</code>, o resultado deve parecer com a saída abaixo.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>● libvirtd.service - Virtualization daemon
</span></span><span style=display:flex><span>     Loaded: loaded <span style=color:#f92672>(</span>/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>     Active: active <span style=color:#f92672>(</span>running<span style=color:#f92672>)</span> since Tue 2022-04-19 08:15:26 -03; 3s ago
</span></span><span style=display:flex><span>TriggeredBy: ● libvirtd.socket
</span></span><span style=display:flex><span>             ● libvirtd-ro.socket
</span></span><span style=display:flex><span>             ● libvirtd-admin.socket
</span></span><span style=display:flex><span>       Docs: man:libvirtd<span style=color:#f92672>(</span>8<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             https://libvirt.org
</span></span><span style=display:flex><span>   Main PID: <span style=color:#ae81ff>203390</span> <span style=color:#f92672>(</span>libvirtd<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      Tasks: <span style=color:#ae81ff>19</span> <span style=color:#f92672>(</span>limit: 32768<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>     Memory: 35.6M
</span></span><span style=display:flex><span>     CGroup: /system.slice/libvirtd.service
</span></span><span style=display:flex><span>             ├─  <span style=color:#ae81ff>1382</span> /usr/sbin/dnsmasq --conf-file<span style=color:#f92672>=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span style=color:#f92672>=</span>/usr/lib/libvirt/libvirt_leaseshelper
</span></span><span style=display:flex><span>             ├─  <span style=color:#ae81ff>1383</span> /usr/sbin/dnsmasq --conf-file<span style=color:#f92672>=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span style=color:#f92672>=</span>/usr/lib/libvirt/libvirt_leaseshelper
</span></span><span style=display:flex><span>             └─203390 /usr/sbin/libvirtd
</span></span></code></pre></div><p>Se o status for diferente de <code>running</code> execute os comandos abaixo para habilitar a inicialização durante o boot e iniciar o serviço agora, depois repita o teste acima.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable libvirtd
</span></span><span style=display:flex><span>sudo systemctl start libvirtd
</span></span></code></pre></div><p>Se tudo correu bem, também foi criada a interface de rede <em>virtual</em> <code>virbr0</code> vinculada a um switch <em>virtual</em> pré configurado no modo <a href=https://en.wikipedia.org/wiki/Network_address_translation target=_blank rel=noopener>NAT</a>
e com o programa <a href=https://en.wikipedia.org/wiki/Dnsmasq target=_blank rel=noopener>dnsmasq</a>
habilitado, conforme diagrama abaixo.</p><p>Maiores detalhes sobre a configuração padrão e dos outros modos disponíveis podem ser obtidos na <a href=https://wiki.libvirt.org/page/VirtualNetworking target=_blank rel=noopener>documentação sobre VirtualNetworking do libvirt</a>
.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:712px><img class=card-img-top src=/docs/fazap/template-vm/libvirt_virtual_network_default_huf1b4c09426728259192ba928ea6a59c7_77903_702x513_fill_q75_box_smart1.jpg width=702 height=513><div class="card-body px-0 pt-2 pb-0"><p class=card-text>Fonte: wiki.libvirt.org/page/File:Virtual_network_default_network_overview.jpg</p></div></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Consultando as interfaces de rede</span>
</span></span><span style=display:flex><span>ip add | grep virbr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state DOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
</span></span><span style=display:flex><span>5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span style=color:#ae81ff>1500</span> qdisc fq_codel master virbr0 state DOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span></code></pre></div><h2 id=criando-templates-de-máquinas-virtuais>Criando templates de máquinas virtuais</h2><p><strong>O que é um template de máquina virtual?</strong> É uma máquina virtual pré-instalada e preparada para servir de base na criação &rsquo;em série&rsquo; de outras máquinas virtuais, dessa forma os procedimentos normalmente demorados de baixa / instalação das aplicações é feito apenas uma vez, gerando um ganho de tempo e consequentemente de produtividade, além de garantir a padronização do que está pré instalado na máquina virtual.</p><p>Os templates são essenciais em processos automatizados, como parte de uma abordagem de <a href=https://en.wikipedia.org/wiki/Infrastructure_as_code target=_blank rel=noopener><strong>IaC</strong> (<em>Infrastructure as Code</em>)</a>
ou de <a href=https://en.wikipedia.org/wiki/Desktop_virtualization target=_blank rel=noopener><strong>VDI</strong> (<em>Virtual Desktop Infrastructure</em>)</a>
.</p><h3 id=escolhendo-a-imagem-base>Escolhendo a imagem base</h3><ul><li>Necessita de uma interface gráfica? ou a interface texto é o suficiente?</li><li>Necessita das últimas versões das aplicações, drivers, etc.? ou&mldr;</li><li>Precisa de versões mais antigas, e teoricamente, mais estáveis das aplicações, drivers, etc.?</li><li>Existe alguma exigência técnica para o uso de um determinado sistema operacional / distribuição?</li><li>Qual distribuição ou sistema operacional você tem mais familiaridade?</li></ul><p>Essas são algumas perguntas que devem surgir no momento de decidir qual sistema operacional / distribuição (Linux) utilizar, independente das respostas tenha em mente estes 2 pontos, dê preferência a imagens <code>net-installer</code>, <code>minimal</code> ou <code>boot-iso</code> e <em><strong>instale apenas o necessário</strong></em>, com isso o tamanho final do template será menor e reduzirá a cobertura de ataques cibernéticos e bugs (por ter menos aplicações instaladas).</p><p>Abaixo segue os link&rsquo;s para as páginas de download de algumas distribuições / sistemas operacionais (em ordem alfabética), fique a vontade para sugerir novas usando os link&rsquo;s ao lado na seção <code>Colabore</code>, obrigado!</p><p><a href=https://www.centos.org/download/ target=_blank rel=noopener>CentOS</a>
| <a href=https://www.debian.org/distrib/index.pt.html target=_blank rel=noopener>Debian</a>
| <a href=https://get.opensuse.org/leapmicro/5.2/ target=_blank rel=noopener>OpenSuse</a>
| <a href=https://ubuntu.com/download/server/ target=_blank rel=noopener>Ubuntu</a>
| <a href=https://www.microsoft.com/pt-br/software-download/windows10ISO target=_blank rel=noopener>Windows 10</a></p><blockquote><p>Para os passos seguintes optamos por utilizar a versão mais recente do <a href=http://mirror.ci.ifes.edu.br/centos/8-stream/isos/x86_64/CentOS-Stream-8-x86_64-latest-boot.iso target=_blank rel=noopener>CentOS-Stream-8-x86_64</a>
.</p></blockquote><h3 id=preparando-para-a-instalação>Preparando para a instalação</h3><p>O primeiro passo é criar uma imagem de disco que servirá para a instalação do sistema operacional, para tanto utilizaremos o utilitário <a href=https://qemu.readthedocs.io/en/latest/tools/qemu-img.html# target=_blank rel=noopener>qemu-img create</a>
, que tem as seguintes opções.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>qemu-img create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>--object OBJECTDEF<span style=color:#f92672>]</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>-q<span style=color:#f92672>]</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>-f FMT<span style=color:#f92672>]</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>-b BACKING_FILE <span style=color:#f92672>[</span>-F BACKING_FMT<span style=color:#f92672>]]</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>-u<span style=color:#f92672>]</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>-o OPTIONS<span style=color:#f92672>]</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  FILENAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>[</span>SIZE<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Para maiores detalhes sobre cada uma das opções acima consulte a <a href=https://qemu.readthedocs.io/en/latest/tools/qemu-img.html#cmdoption-qemu-img-commands-arg-create target=_blank rel=noopener>documentação da opção create</a>
.</p><p>Vamos executar o comando abaixo para criar a nossa imagem de disco no formato <a href=https://qemu.readthedocs.io/en/latest/system/images.html#cmdoption-image-formats-arg-qcow2 target=_blank rel=noopener>qcow2</a>
usando a <a href=https://qemu.readthedocs.io/en/latest/system/images.html#cmdoption-qcow2-arg-preallocation target=_blank rel=noopener>pré-alocação dos metadados</a>
, gravando-a na pasta <code>/var/lib/libvirt/images/</code> (altere o nome da imagem para melhor identifica-la depois) e por fim especifique um tamanho para a mesma.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo qemu-img create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -f qcow2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -o preallocation<span style=color:#f92672>=</span>metadata <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  /var/lib/libvirt/images/centos8-slim.qcow2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  15G
</span></span></code></pre></div><p>A saída desse comando será algo parecido com o trecho abaixo.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Formatting <span style=color:#e6db74>&#39;/var/lib/libvirt/images/centos8-slim.qcow2&#39;</span>, fmt<span style=color:#f92672>=</span>qcow2 size<span style=color:#f92672>=</span><span style=color:#ae81ff>16106127360</span> cluster_size<span style=color:#f92672>=</span><span style=color:#ae81ff>65536</span>
</span></span><span style=display:flex><span>preallocation<span style=color:#f92672>=</span>metadata lazy_refcounts<span style=color:#f92672>=</span>off refcount_bits<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>Para gerenciarmos nossas máquinas virtuais temos 2 opções, ambas criadas com base na biblioteca <code>libvirt</code>:</p><ul><li><a href=https://libvirt.org/manpages/virsh.html target=_blank rel=noopener>virsh</a>
(linha de comando);</li><li><a href=https://virt-manager.org/ target=_blank rel=noopener>virt-manager</a>
(interface gráfica);</li></ul><p>Adicionalmente ainda temos à disposição as seguintes ferramentas de suporte, também criadas usando a <code>libvirt</code>.</p><ul><li><a href=https://linux.die.net/man/1/virt-install target=_blank rel=noopener>virt-install</a>
para provisionar novas máquinas virtuais.</li><li><a href=https://linux.die.net/man/1/virt-viewer target=_blank rel=noopener>virt-viewer</a>
exibe o console gráfico para uma máquina virtual.</li><li><a href=https://linux.die.net/man/1/virt-clone target=_blank rel=noopener>virt-clone</a>
para clonar imagens de máquinas virtuais existentes.</li><li><a href=https://www.systutorials.com/docs/linux/man/1-virt-xml/ target=_blank rel=noopener>virt-xml</a>
para editar o XML do domínio libvirt.</li><li><a href=https://github.com/virt-manager/virt-bootstrap target=_blank rel=noopener>virt-bootstrap</a>
configura o sistema de arquivos raiz para contêineres baseados em libvirt.</li></ul><h3 id=instalando-o-sistema-operacional>Instalando o sistema operacional</h3><h4 id=revisando--conhecendo-as-opções-do-comando-virt-install>Revisando / conhecendo as opções do comando <code>virt-install</code></h4><p>Se já tem algum tempo da publicação deste material ou se você gosta de saber com o que esta lidando, é recomendável consultar a documentação com o comando <code>man virt-install</code>, para verificar se as opções permanecem as mesmas, se não foram substituídas, se existem novas opções, etc.</p><p>Uma vez carregada a documentação algumas dicas podem nos poupar tempo para localizarmos o que precisamos em conteúdos extensos como este do <code>virt-install</code>.</p><ul><li>Para localizar o texto &lsquo;&ndash;virt-type&rsquo; digite <code>/--virt-type&lt;&lt;ENTER>></code>.</li><li>Para ir para a próxima ocorrência do texto use <code>n</code> e para voltar para as ocorrências anteriores <code>N</code>.</li></ul><h4 id=iniciando-a-instalação>Iniciando a instalação</h4><p>Uma vez terminada a consulta / validação das opções abaixo, vamos executar o comando e iniciar a instalação.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo virt-install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --virt-type kvm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name centos8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --memory <span style=color:#ae81ff>2048</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --disk /var/lib/libvirt/images/centos8-slim.qcow2,format<span style=color:#f92672>=</span>qcow2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --network network<span style=color:#f92672>=</span>default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --graphics vnc,listen<span style=color:#f92672>=</span>0.0.0.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --noautoconsole <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --os-variant<span style=color:#f92672>=</span>centos-stream8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --cdrom<span style=color:#f92672>=</span>/home/sandro/Downloads/CentOS-Stream-8-x86_64-latest-boot.iso
</span></span></code></pre></div><p>Após o comando acima apareceu uma mensagem informando que a instalação ainda está em progresso, vamos confirmar se temos alguma máquina virtual em execução no momento?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virsh list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Id   Name      State
</span></span><span style=display:flex><span>-------------------------
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2</span>    centos8   running
</span></span></code></pre></div><p>Show! Então agora precisamos acessar a console dessa máquina virtual e concluir a instalação do nosso sistema operacional, para tanto execute o comando abaixo.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virt-viewer centos8
</span></span></code></pre></div><p>Deverá aparecer a tela abaixo, de boas vindas à instalação do CentOS Stream 8, onde a primeira coisa é escolher o idioma a ser utilizado no processo de instalação.</p><div class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:712px><img class=card-img-top src=/docs/fazap/template-vm/welcome-centos-stream-8_hufbcefd3c0e93f87e9ba98fc5032c30ba_141814_702x513_fill_box_smart1_3.png width=702 height=513><div class="card-body px-0 pt-2 pb-0"><p class=card-text></p></div></div><p>A partir deste ponto, <strong>cada caso é um caso</strong> e, dependendo da função das máquinas virtuais a serem criadas com este template, iremos instalar um determinado conjunto de pacotes / programas. Fora alguns casos especificos, o mais indicado é <strong>instalar apenas o necessário</strong>, por exemplo:</p><ul><li>Se a função da máquina virtual for ser um servidor de aplicação, onde iremos acessar basicamente via terminal, realmente é necessário ter uma interface gráfica?</li></ul><p>Lembre-se! Quanto menos programas tivermos instalados em nosso sistema, menor será a cobertura de ataques ciberneticos e menor o espaço ocupado em disco.</p><p>Bom! Uma vez concluída a instalação inicial do sistema operacional para para as etapas finais.</p><h3 id=acessando-a-máquina-virtual>Acessando a máquina virtual</h3><p>Uma vez concluída a instalação a máquina virtual é desligada, podemos verificar este estado com o comando abaixo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virsh list --all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Id   Name      State
</span></span><span style=display:flex><span>--------------------------
</span></span><span style=display:flex><span> -    centos8   shut off
</span></span></code></pre></div><p>Para &rsquo;ligar&rsquo; a máquina virtual execute o comando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virsh start centos8
</span></span></code></pre></div><p>E para acessar a console da máquina virtual utilize o mesmo comando de antes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virt-viewer centos8
</span></span></code></pre></div><p>Se preferir pode usar o <code>virt-manager</code> para acessar estas e outras funcionalidades via interface gráfica.</p><h3 id=ajustes-pós-install>Ajustes pós install</h3><p>Para completar a instalação do sistema operacional vamos instalar alguns pacotes básicos e necessários para a manutenção futura de nossa máquina virtual.</p><blockquote><p>Se quiser acessar</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum update -y;
</span></span><span style=display:flex><span>sudo yum install -y <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  epel-release <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  wget <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  telnet <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  net-tools <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  unzip;
</span></span></code></pre></div><p>Para concluirmos esta etapa, precisamos desabilitar a funcionalidade <a href=https://en.wikipedia.org/wiki/Zero-configuration_networking target=_blank rel=noopener>ZeroConf</a>
para que a configuração de rede seja feita manualmente quando da instalação das futuras máquinas virtuais baseadas neste template, para tanto execute o comando abaixo.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo echo <span style=color:#e6db74>&#34;NOZEROCONF=yes&#34;</span> &gt;&gt; /etc/sysconfig/network
</span></span></code></pre></div><p>Pronto, agora podemos ir para a etapa final, então vamos desligar a nossa máquina virtual.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo poweroff
</span></span></code></pre></div><h3 id=limpando-a-imagem>Limpando a imagem</h3><p>Antes de seguir certifique-se que a máquina virtual está desligada.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virsh list --all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Id   Name      State
</span></span><span style=display:flex><span>--------------------------
</span></span><span style=display:flex><span> -    centos8   shut off
</span></span></code></pre></div><p>Agora vamos utilizar o útilitário <a href=https://libguestfs.org/virt-sysprep.1.html target=_blank rel=noopener>virt-sysprep</a>
que tem a função de redefinir, desconfigurar ou personalizar uma máquina virtual para que possam ser feitos os clones dessa máquina virtual.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo virt-sysprep -d centos8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> senha para sandro: 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   0.0<span style=color:#f92672>]</span> Examining the guest ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.0<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;abrt-data&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.0<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;backup-files&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.2<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;bash-history&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.2<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;blkid-tab&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.2<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;crash-data&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.2<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;cron-spool&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.3<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;dhcp-client-state&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.3<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;dhcp-server-state&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.3<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;dovecot-data&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.3<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;logfiles&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.4<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;machine-id&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.4<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;mail-spool&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.4<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;net-hostname&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.4<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;net-hwaddr&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.5<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;pacct-log&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.5<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;package-manager-cache&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.6<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;pam-data&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.6<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;passwd-backups&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.6<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;puppet-data-log&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.6<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;rh-subscription-manager&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.7<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;rhn-systemid&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.7<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;rpm-db&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.7<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;samba-db-log&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.7<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;script&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.7<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;smolt-uuid&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.8<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;ssh-hostkeys&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.8<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;ssh-userdir&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.8<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;sssd-db-log&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.8<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;tmp-files&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.8<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;udev-persistent-net&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.8<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;utmp&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.9<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;yum-uuid&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.9<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;customize&#34;</span> ...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.9<span style=color:#f92672>]</span> Setting a random seed
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   5.9<span style=color:#f92672>]</span> Setting the machine ID in /etc/machine-id
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>   6.0<span style=color:#f92672>]</span> Performing <span style=color:#e6db74>&#34;lvm-uuids&#34;</span> ...
</span></span></code></pre></div><p>E agora vamos remover a configuração da máquina virtual com o comando abaixo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo virsh undefine centos8
</span></span></code></pre></div><p>Pronto! Procedimento concluído, agora podemos clonar a nossa máquina virtual nos próximos artigos.</p><p>Espero que tenha gostado, deixe seu Feedback abaixo e sinta-se à vontade para colaborar usando o menu da direita.</p><p>Até breve!</p><div class=section-index></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Gostou desta página?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Sim</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">Não</button><p class="feedback--response feedback--response-yes">Que bom, que gostou! Por favor, <a href="https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/issues/new?title=Sugestoes">tem algo que podemos melhorar</a>?</p><p class="feedback--response feedback--response-no">Que pena! Por favor, <a href="https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/issues/new?title=Melhorias">me diga o que podemos fazer pra melhorar</a>. Obrigado!</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=t=>{if(typeof ga!='function')return;const e={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:t};ga(e.command,e.hitType,e.category,e.action,e.label,e.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">Última modificação 14 de Jun de 2022: <a href=https://github.com/sandrorgguimaraes/sandrorgguimaraes.github.io/commit/3c0f1efaef12be293713c067dabb157adb373503>Ajustes finos na formatação 'Certificações - CKA'. (3c0f1ef)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel=noopener href=https://www.linkedin.com/in/sandrorgguimaraes/ aria-label=LinkedIn><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://www.twitter.com/sandrorogerio/ aria-label=Twitter><i class="fab fa-twitter-square"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/sandrorgguimaraes/ aria-label=GitHub><i class="fab fa-github-square"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Sandro Rogério Galvão Guimarães Todos os direitos reservados</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.63f7ccf0f6f052be82a52cc628622eadcdaa7d38aa242c60a3cad13badb12dd9.js integrity="sha256-Y/fM8PbwUr6CpSzGKGIurc2qfTiqJCxgo8rRO62xLdk=" crossorigin=anonymous></script></body></html>